$subId = "YOUR_SUBSCRIPTION_ID"
$rg = "YOUR_RESOURCE_GROUP"
$domain = "YOUR_DOMAIN"
$user = "DOMAIN_ADMIN_USER"
$p = "PASSWORD"
$pass = ConvertTo-SecureString $p -AsPlainText -Force

Set-AzContext -SubscriptionId $subId
$cred = New-Object PSCredential ($user, $pass)
$vms = Get-AzVM -ResourceGroupName $rg
foreach ($vm in $vms) {
    Set-AzVMExtension `
        -ResourceGroupName $rg `
        -VMName $vm.Name `
        -Name "joindomain" `
        -Publisher "Microsoft.Compute" `
        -ExtensionType "JsonADDomainExtension" `
        -TypeHandlerVersion "1.3" `
        -Settings @{
            "Name" = $domain
            "User" = $user
            "Restart" = "true"
            "Options" = 3
        } `
        -ProtectedSettings @{
            "Password" = $p
        }
}
 
